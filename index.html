<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>AVECTRUM — Créditos</title>

  <style>
    :root{
      --bg:#07070a;
      --card:#0e0f14;
      --stroke:rgba(255,255,255,.10);
      --text:#e9eef6;
      --muted:rgba(255,255,255,.62);
      --red:#ff5757;
      --shadow: 0 14px 34px rgba(0,0,0,.55);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 420px at 18% -10%, rgba(255,87,87,.12), transparent 60%),
        radial-gradient(900px 420px at 82% 0%, rgba(255,87,87,.08), transparent 60%),
        linear-gradient(180deg, #050507, #07070a 55%, #050507);
      min-height:100vh;
      padding:26px 14px 60px;
    }
    .wrap{max-width:980px;margin:0 auto}

    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      margin-bottom:14px;
    }
    .brand{
      display:flex;align-items:center;gap:12px;
      font-weight:950;
      letter-spacing:.6px;
      font-size:18px;
    }
    .badge{
      font-size:11px;
      padding:6px 10px;
      border:1px solid rgba(255,87,87,.35);
      background:rgba(255,87,87,.10);
      border-radius:999px;
      color:rgba(255,255,255,.92);
      letter-spacing:.12em;
      text-transform:uppercase;
    }
    .btnGhost{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.03);
      color:var(--text);
      padding:10px 14px;
      border-radius:999px;
      cursor:pointer;
      transition:.2s;
      font-weight:900;
    }
    .btnGhost:hover{transform:translateY(-1px);border-color:rgba(255,255,255,.22)}

    .hero{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:14px;
      margin:10px 0 16px;
    }
    @media (max-width:860px){ .hero{grid-template-columns:1fr} }

    .card{
      background:rgba(255,255,255,.03);
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      padding:18px;
      box-shadow: var(--shadow);
    }
    .title{
      font-size:26px;margin:0 0 8px;font-weight:1000;letter-spacing:.2px;
    }
    .subtitle{margin:0;color:var(--muted);font-size:14px;line-height:1.45}
    .miniRow{
      margin-top:12px;
      display:flex;gap:10px;flex-wrap:wrap;
    }
    .mini{
      font-size:12px;
      color:var(--muted);
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.25);
      padding:6px 10px;
      border-radius:999px;
    }
    .mini b{color:rgba(255,255,255,.92)}
    .mini .red{color:var(--red)}

    .stepsCard{
      background:rgba(0,0,0,.26);
      border:1px solid rgba(255,255,255,.10);
      border-radius:var(--radius);
      padding:16px;
    }

    .stepHeader{
      display:flex;align-items:flex-start;justify-content:space-between;gap:16px;flex-wrap:wrap;
      margin-bottom:10px;
    }
    .stepTitle small{
      color:rgba(255,255,255,.55);
      letter-spacing:.14em;text-transform:uppercase;font-size:11px;
    }
    .stepTitle b{display:block;font-size:22px;margin-top:4px}
    .stepTitle span{display:block;margin-top:4px;color:var(--muted);font-size:13px}

    .progress{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .dot{
      width:10px;height:10px;border-radius:999px;
      background:rgba(255,255,255,.18);
      border:1px solid rgba(255,255,255,.14);
    }
    .dot.active{background:var(--red);border-color:rgba(255,87,87,.55)}
    .line{width:60px;height:2px;background:rgba(255,255,255,.16)}
    .line.active{background:rgba(255,87,87,.55)}
    .stepLabel{
      font-size:11px;color:rgba(255,255,255,.55);
      letter-spacing:.10em;text-transform:uppercase;
    }
    .stepLabel.active{color:rgba(255,255,255,.92)}

    .grid2{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:14px;
      margin-top:14px;
    }
    @media (max-width:860px){ .grid2{grid-template-columns:1fr} }

    .box{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.02);
      border-radius:16px;
      padding:14px;
    }
    .boxTitle{
      font-size:12px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color:rgba(255,255,255,.60);
      margin-bottom:8px;
    }

    .cards{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:10px;
    }
    @media (max-width:560px){ .cards{grid-template-columns:1fr} }

    .opt{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.25);
      border-radius:16px;
      padding:14px;
      cursor:pointer;
      transition:.18s;
      position:relative;
    }
    .opt:hover{transform:translateY(-1px);border-color:rgba(255,255,255,.18)}
    .opt.active{
      border-color:rgba(255,87,87,.65);
      box-shadow: 0 0 0 3px rgba(255,87,87,.12);
    }
    .opt .top{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .opt .name{font-weight:1000;font-size:16px}
    .opt .price{font-weight:1000;color:var(--red);font-size:16px}
    .opt .desc{margin-top:6px;color:var(--muted);font-size:13px}
    .tag{
      display:inline-block;
      margin-top:8px;
      font-size:11px;
      padding:5px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      color:rgba(255,255,255,.82);
      background:rgba(255,255,255,.03);
    }

    .inputs{
      display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px;
    }
    @media (max-width:560px){ .inputs{grid-template-columns:1fr} }
    input, select{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.25);
      color:var(--text);
      outline:none;
    }
    select{ color-scheme: dark; }
    select option{
      background:#0e0f14;
      color:#e9eef6;
    }

    input::placeholder{color:rgba(255,255,255,.35)}
    input:focus, select:focus{border-color:rgba(255,87,87,.45)}

    .row{
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
      color:var(--muted);font-size:13px;
      margin-top:8px;
    }
    .row strong{color:rgba(255,255,255,.92)}
    .total{font-size:22px;font-weight:1000;color:var(--red)}

    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    .btn{
      padding:12px 14px;
      border-radius:999px;
      border:1px solid rgba(255,87,87,.45);
      background:linear-gradient(180deg, rgba(255,87,87,.25), rgba(255,87,87,.12));
      color:rgba(255,255,255,.95);
      font-weight:1000;
      cursor:pointer;
      transition:.2s;
      min-width:220px;
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
    }
    .btn:hover{transform:translateY(-1px);border-color:rgba(255,87,87,.70)}
    .btn2{
      padding:12px 14px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.04);
      color:rgba(255,255,255,.90);
      font-weight:1000;
      cursor:pointer;
      transition:.2s;
      min-width:220px;
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
    }
    .btn2:hover{transform:translateY(-1px);border-color:rgba(255,255,255,.22)}

    .pixBox{
      margin-top:10px;
      padding:12px;
      border-radius:14px;
      border:1px dashed rgba(255,87,87,.55);
      background:rgba(255,87,87,.08);
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
    }
    .pixKey{font-weight:1000;color:rgba(255,255,255,.92);word-break:break-all}
    .copyBtn{
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.25);
      color:rgba(255,255,255,.92);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:1000;
    }
    .copyBtn:hover{border-color:rgba(255,255,255,.26)}

    .warn{margin-top:10px;font-size:12px;color:rgba(255,255,255,.55)}
    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background:rgba(0,0,0,.72);
      border:1px solid rgba(255,255,255,.12);
      padding:10px 12px;border-radius:999px;
      color:rgba(255,255,255,.92);
      font-size:13px;
      display:none;
      z-index:50;
    }
    .bigMsg{
      font-size:14px;
      color:rgba(255,255,255,.80);
      line-height:1.5;
      margin:6px 0 0;
    }
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      letter-spacing:.04em;
    }
  </style>
</head>

<body>
<div class="wrap">

  <div class="topbar">
    <div class="brand">
      AVECTRUM <span class="badge">créditos</span>
    </div>
    <button class="btnGhost" onclick="resetFlow()">↩ Reiniciar</button>
  </div>

  <div class="hero">
    <div class="card">
      <h1 class="title">Comprar créditos</h1>
      <p class="subtitle">
        Selecione um pacote, escolha a indicação (de quem você veio) e finalize via <b>Pix</b>.
        Depois, confirme o pagamento.
      </p>

      <div class="miniRow">
        <div class="mini">Total atual: <b id="miniTotal" class="red">R$ 0,00</b></div>
        <div class="mini">Pacote: <b id="miniPack">—</b></div>
        <div class="mini">Indicação: <b id="miniRef">—</b></div>
        <div class="mini">Código: <b id="miniCode" class="red">—</b></div>
      </div>
    </div>

    <div class="card">
      <p class="subtitle" style="margin:0;">
        * GitHub Pages não tem banco de dados. Para controle, a confirmação vai para seu Telegram via <b>Cloudflare Worker</b>
        com: <b>nome</b>, <b>WhatsApp</b>, <b>créditos</b>, <b>valor</b>, <b>indicação</b> e <b>código</b>.
      </p>
      <div class="warn">Dica: abra com <b>?ref=JOAO01</b> (ex: <b>.../?ref=JOAO01</b>) para sugerir a indicação automaticamente.</div>
    </div>
  </div>

  <div class="stepsCard">
    <div class="stepHeader">
      <div class="stepTitle">
        <small id="stepSmall">ETAPA 1 DE 4</small>
        <b id="stepBig">Escolher créditos</b>
        <span id="stepSub">Selecione o pacote de créditos.</span>
      </div>

      <div class="progress">
        <span class="dot active" id="dot1"></span><span class="line" id="line1"></span>
        <span class="dot" id="dot2"></span><span class="line" id="line2"></span>
        <span class="dot" id="dot3"></span><span class="line" id="line3"></span>
        <span class="dot" id="dot4"></span>

        <span class="stepLabel active" id="lbl1">Créditos</span>
        <span class="stepLabel" id="lbl2">Indicação</span>
        <span class="stepLabel" id="lbl3">Pix</span>
        <span class="stepLabel" id="lbl4">Confirmar</span>
      </div>
    </div>

    <!-- STEP 1 -->
    <section id="step1">
      <div class="grid2">
        <div class="box">
          <div class="boxTitle">Selecione um pacote</div>

          <div id="packages" class="cards"></div>

          <div class="actions">
            <button class="btn" type="button" onclick="goStep(2)">Continuar →</button>
          </div>
          <div class="warn">Você precisa escolher um pacote para continuar.</div>
        </div>

        <div class="box">
          <div class="boxTitle">Resumo</div>
          <div class="row"><span>Pacote</span><strong id="sumPack1">—</strong></div>
          <div class="row"><span>Total</span><strong class="total" id="sumTotal1">R$ 0,00</strong></div>
          <div class="row"><span>Indicação</span><strong id="sumRef1">—</strong></div>
          <div class="row"><span>Código</span><strong id="sumCode1" class="mono">—</strong></div>
        </div>
      </div>
    </section>

    <!-- STEP 2 -->
    <section id="step2" style="display:none;">
      <div class="grid2">
        <div class="box">
          <div class="boxTitle">Dados + Indicação</div>

          <div class="inputs">
            <input id="buyerName" placeholder="Seu nome" />
            <input id="buyerWhats" placeholder="Seu WhatsApp" />
          </div>

          <div style="margin-top:10px;">
            <select id="refSelect"></select>
            <div class="warn">Se não tiver na lista, selecione “Outro” e escreva.</div>
            <input id="refOther" placeholder="Digite a indicação (ex: JOAO01)" style="margin-top:10px; display:none;" />
          </div>

          <div class="actions">
            <button class="btn2" type="button" onclick="goStep(1)">← Voltar</button>
            <button class="btn" type="button" onclick="goStep(3)">Ir para Pix →</button>
          </div>
        </div>

        <div class="box">
          <div class="boxTitle">Revisão</div>
          <div class="row"><span>Pacote</span><strong id="sumPack2">—</strong></div>
          <div class="row"><span>Total</span><strong class="total" id="sumTotal2">R$ 0,00</strong></div>
          <div class="row"><span>Indicação</span><strong id="sumRef2">—</strong></div>
          <div class="row"><span>Código</span><strong id="sumCode2" class="mono">—</strong></div>
        </div>
      </div>
    </section>

    <!-- STEP 3 -->
    <section id="step3" style="display:none;">
      <div class="grid2">
        <div class="box">
          <div class="boxTitle">Pagamento via Pix</div>

          <div class="pixBox">
            <div>
              <div style="font-size:12px;color:rgba(255,255,255,.65);letter-spacing:.08em;text-transform:uppercase">Chave Pix</div>
              <div class="pixKey" id="pixKeyUI">SUA_CHAVE_PIX</div>
            </div>
            <button class="copyBtn" type="button" onclick="copyPix()">Copiar Pix</button>
          </div>

          <!-- CÓDIGO DE COMPRA (copiável) -->
          <div class="pixBox">
            <div>
              <div style="font-size:12px;color:rgba(255,255,255,.65);letter-spacing:.08em;text-transform:uppercase">Código da compra</div>
              <div class="pixKey mono" id="purchaseCodeUI">—</div>
            </div>
            <button class="copyBtn" type="button" onclick="copyCode()">Copiar código</button>
          </div>

          <div class="box" style="margin-top:14px;">
            <div class="boxTitle">Seu pedido</div>
            <div class="row"><span>Pacote</span><strong id="sumPack3">—</strong></div>
            <div class="row"><span>Total</span><strong class="total" id="sumTotal3">R$ 0,00</strong></div>
            <div class="row"><span>Indicação</span><strong id="sumRef3">—</strong></div>
            <div class="row"><span>Código</span><strong id="sumCode3" class="mono">—</strong></div>
          </div>

          <div class="actions">
            <button class="btn2" type="button" onclick="goStep(2)">← Voltar</button>
            <button class="btn" type="button" onclick="goStep(4)">Já paguei →</button>
          </div>

          <div class="warn">
            Faça o Pix e guarde seu <b>código</b>. Em seguida clique em <b>“Já paguei”</b>.
          </div>
        </div>

        <div class="box">
          <div class="boxTitle">O que vai no Telegram</div>
          <div class="row"><span>Nome</span><strong id="tgName">—</strong></div>
          <div class="row"><span>WhatsApp</span><strong id="tgWhats">—</strong></div>
          <div class="row"><span>Pacote</span><strong id="tgPack">—</strong></div>
          <div class="row"><span>Valor</span><strong id="tgTotal">—</strong></div>
          <div class="row"><span>Indicação</span><strong id="tgRef">—</strong></div>
          <div class="row"><span>Código</span><strong id="tgCode" class="mono">—</strong></div>
        </div>
      </div>
    </section>

    <!-- STEP 4 -->
    <section id="step4" style="display:none;">
      <div class="grid2">
        <div class="box">
          <div class="boxTitle">Confirmação</div>
          <p class="bigMsg">
            Se precisar falar comigo no WhatsApp:
            <b class="mono" id="whatsNumberUI">—</b>
          </p>

          <div class="actions" style="margin-top:12px;">
            <button class="btn2" type="button" onclick="goStep(3)">← Voltar</button>
            <button class="btn" type="button" onclick="confirmPayment()">Eu fiz o pagamento</button>
          </div>

          <div class="warn">
            Ao clicar em <b>“Eu fiz o pagamento”</b>, o site envia a confirmação pro seu <b>Worker</b> e ele manda no seu <b>Telegram</b>.
          </div>
        </div>

        <div class="box">
          <div class="boxTitle">Resumo final</div>
          <div class="row"><span>Nome</span><strong id="finalName">—</strong></div>
          <div class="row"><span>WhatsApp</span><strong id="finalWhats">—</strong></div>
          <div class="row"><span>Pacote</span><strong id="finalPack">—</strong></div>
          <div class="row"><span>Total</span><strong id="finalTotal" class="total">—</strong></div>
          <div class="row"><span>Indicação</span><strong id="finalRef">—</strong></div>
          <div class="row"><span>Código</span><strong id="finalCode" class="mono">—</strong></div>
        </div>
      </div>
    </section>

  </div>
</div>

<div class="toast" id="toast">Copiado!</div>

<script>
  // =======================
  // CONFIGURE AQUI
  // =======================
  const PIX_KEY = "SUA_CHAVE_PIX_AQUI";     // <= TROQUE
  const WHATSAPP_NUMBER = "55XXXXXXXXXXX";  // <= TROQUE (ex: 5511999999999)

  // ✅ URL DO SEU WORKER (Cloudflare)
  // Confere no botão "Visit" ou em Settings > Domains & Routes
  const WORKER_URL = "https://avectrum-pay-notify.marlonarruda55.workers.dev/"; // <= TROQUE se estiver diferente

  // (opcional) lista de pessoas/códigos que podem indicar
  const INDICADORES = [
    "direto",
    "JOAO01",
    "ANA02",
    "MARCOS03",
    "GUTO",
    "TKZ Community"
  ];

  // =======================
  // PACOTES (DA SUA TABELA)
  // =======================
  const PACKAGES = [
    { base: 10,  bonus: 0,   price: 3.00 },
    { base: 20,  bonus: 10,  price: 6.00 },
    { base: 30,  bonus: 15,  price: 9.00 },
    { base: 40,  bonus: 20,  price: 12.00 },
    { base: 50,  bonus: 30,  price: 14.90 },
    { base: 100, bonus: 50,  price: 19.90 },
    { base: 150, bonus: 75,  price: 29.90 },
    { base: 200, bonus: 100, price: 34.90 },
    { base: 300, bonus: 150, price: 49.90 },
    { base: 500, bonus: 250, price: 79.90 },
    { base: 1000,bonus: 300, price: 109.90 },
    { base: 1500,bonus: 450, price: 154.90 },
    { base: 2000,bonus: 600, price: 199.90 },
    { base: 5000,bonus: 500, price: 239.90 },
  ];

  // =======================
  // STATE
  // =======================
  const qs = new URLSearchParams(location.search);
  const refFromUrl = (qs.get("ref") || "").trim();
  let selectedIndex = -1;
  let purchaseCode = ""; // <- código da compra

  // =======================
  // HELPERS
  // =======================
  const brl = (n) => n.toLocaleString("pt-BR", { style:"currency", currency:"BRL" });

  function pkgLabel(p){
    const totalCredits = p.base + p.bonus;
    if(p.bonus > 0) return `${p.base} + ${p.bonus} (bônus) = ${totalCredits} créditos`;
    return `${p.base} créditos`;
  }

  function selectedPkg(){
    return selectedIndex >= 0 ? PACKAGES[selectedIndex] : null;
  }

  function generatePurchaseCode(){
    const d = new Date();
    const date =
      String(d.getDate()).padStart(2,"0") +
      String(d.getMonth()+1).padStart(2,"0") +
      String(d.getFullYear()).slice(-2);

    const rand = Math.random().toString(36).substring(2,7).toUpperCase();
    return `AVE-${date}-${rand}`;
  }

  function setProgress(step){
    const dot1 = document.getElementById("dot1");
    const dot2 = document.getElementById("dot2");
    const dot3 = document.getElementById("dot3");
    const dot4 = document.getElementById("dot4");
    const line1 = document.getElementById("line1");
    const line2 = document.getElementById("line2");
    const line3 = document.getElementById("line3");
    const lbl1 = document.getElementById("lbl1");
    const lbl2 = document.getElementById("lbl2");
    const lbl3 = document.getElementById("lbl3");
    const lbl4 = document.getElementById("lbl4");

    [dot1,dot2,dot3,dot4].forEach(d=>d.classList.remove("active"));
    [line1,line2,line3].forEach(l=>l.classList.remove("active"));
    [lbl1,lbl2,lbl3,lbl4].forEach(l=>l.classList.remove("active"));

    if(step===1){
      dot1.classList.add("active");
      lbl1.classList.add("active");
      document.getElementById("stepSmall").textContent = "ETAPA 1 DE 4";
      document.getElementById("stepBig").textContent = "Escolher créditos";
      document.getElementById("stepSub").textContent = "Selecione o pacote de créditos.";
    }
    if(step===2){
      dot1.classList.add("active"); dot2.classList.add("active");
      line1.classList.add("active");
      lbl2.classList.add("active");
      document.getElementById("stepSmall").textContent = "ETAPA 2 DE 4";
      document.getElementById("stepBig").textContent = "Indicação";
      document.getElementById("stepSub").textContent = "Informe seus dados e selecione de quem veio.";
    }
    if(step===3){
      dot1.classList.add("active"); dot2.classList.add("active"); dot3.classList.add("active");
      line1.classList.add("active"); line2.classList.add("active");
      lbl3.classList.add("active");
      document.getElementById("stepSmall").textContent = "ETAPA 3 DE 4";
      document.getElementById("stepBig").textContent = "Pix + Código";
      document.getElementById("stepSub").textContent = "Copie o Pix e o código da compra.";
    }
    if(step===4){
      dot1.classList.add("active"); dot2.classList.add("active"); dot3.classList.add("active"); dot4.classList.add("active");
      line1.classList.add("active"); line2.classList.add("active"); line3.classList.add("active");
      lbl4.classList.add("active");
      document.getElementById("stepSmall").textContent = "ETAPA 4 DE 4";
      document.getElementById("stepBig").textContent = "Confirmar pagamento";
      document.getElementById("stepSub").textContent = "Clique em “Eu fiz o pagamento” para enviar a confirmação.";
    }
  }

  function getRefFinal(){
    const sel = document.getElementById("refSelect").value;
    if(sel === "__other__"){
      return (document.getElementById("refOther").value || "").trim() || "direto";
    }
    return (sel || "direto").trim();
  }

  function syncSummary(){
    const p = selectedPkg();
    const ref = getRefFinal();

    const codeTxt = purchaseCode || "—";
    document.getElementById("miniCode").textContent = codeTxt;
    document.getElementById("sumCode1").textContent = codeTxt;
    document.getElementById("sumCode2").textContent = codeTxt;
    document.getElementById("sumCode3").textContent = codeTxt;

    document.getElementById("purchaseCodeUI").textContent = codeTxt;

    document.getElementById("miniRef").textContent = ref;
    document.getElementById("sumRef1").textContent = ref;
    document.getElementById("sumRef2").textContent = ref;
    document.getElementById("sumRef3").textContent = ref;

    if(!p){
      document.getElementById("miniTotal").textContent = brl(0);
      document.getElementById("miniPack").textContent = "—";
      document.getElementById("sumPack1").textContent = "—";
      document.getElementById("sumPack2").textContent = "—";
      document.getElementById("sumPack3").textContent = "—";
      document.getElementById("sumTotal1").textContent = brl(0);
      document.getElementById("sumTotal2").textContent = brl(0);
      document.getElementById("sumTotal3").textContent = brl(0);
    } else {
      const packText = pkgLabel(p);
      document.getElementById("miniPack").textContent = packText;
      document.getElementById("sumPack1").textContent = packText;
      document.getElementById("sumPack2").textContent = packText;
      document.getElementById("sumPack3").textContent = packText;

      document.getElementById("miniTotal").textContent = brl(p.price);
      document.getElementById("sumTotal1").textContent = brl(p.price);
      document.getElementById("sumTotal2").textContent = brl(p.price);
      document.getElementById("sumTotal3").textContent = brl(p.price);
    }

    const name = (document.getElementById("buyerName").value || "").trim();
    const whats = (document.getElementById("buyerWhats").value || "").trim();

    document.getElementById("tgName").textContent = name || "—";
    document.getElementById("tgWhats").textContent = whats || "—";
    document.getElementById("tgPack").textContent = p ? pkgLabel(p) : "—";
    document.getElementById("tgTotal").textContent = p ? brl(p.price) : "—";
    document.getElementById("tgRef").textContent = ref;
    document.getElementById("tgCode").textContent = purchaseCode || "—";

    document.getElementById("finalName").textContent = name || "—";
    document.getElementById("finalWhats").textContent = whats || "—";
    document.getElementById("finalPack").textContent = p ? pkgLabel(p) : "—";
    document.getElementById("finalTotal").textContent = p ? brl(p.price) : "—";
    document.getElementById("finalRef").textContent = ref;
    document.getElementById("finalCode").textContent = purchaseCode || "—";
  }

  function goStep(step){
    if(step === 2){
      if(selectedIndex < 0){
        alert("Selecione um pacote de créditos para continuar.");
        return;
      }
    }
    if(step === 3){
      const name = (document.getElementById("buyerName").value || "").trim();
      const whats = (document.getElementById("buyerWhats").value || "").trim();
      if(!name || !whats){
        alert("Preencha seu nome e WhatsApp para continuar.");
        return;
      }
      const ref = getRefFinal();
      if(!ref){
        alert("Selecione a indicação.");
        return;
      }
      if(!purchaseCode){
        purchaseCode = generatePurchaseCode();
      }
    }
    if(step === 4){
      if(!purchaseCode){
        alert("Primeiro informe seus dados e gere o código na etapa do Pix.");
        return;
      }
    }

    document.getElementById("step1").style.display = (step===1) ? "block" : "none";
    document.getElementById("step2").style.display = (step===2) ? "block" : "none";
    document.getElementById("step3").style.display = (step===3) ? "block" : "none";
    document.getElementById("step4").style.display = (step===4) ? "block" : "none";

    setProgress(step);
    syncSummary();
    window.scrollTo({top:0, behavior:"smooth"});
  }

  function renderPackages(){
    const host = document.getElementById("packages");
    host.innerHTML = "";

    PACKAGES.forEach((p, idx) => {
      const div = document.createElement("div");
      div.className = "opt";
      div.onclick = () => selectPackage(idx);

      const totalCredits = p.base + p.bonus;
      const bonusText = p.bonus > 0 ? `BÔNUS +${p.bonus}` : "SEM BÔNUS";

      div.innerHTML = `
        <div class="top">
          <div class="name">${p.base}${p.bonus>0 ? ` + ${p.bonus}` : ""} créditos</div>
          <div class="price">${brl(p.price)}</div>
        </div>
        <div class="desc">Total: <b>${totalCredits}</b> créditos</div>
        <span class="tag">${bonusText}</span>
      `;

      host.appendChild(div);
    });
  }

  function selectPackage(idx){
    selectedIndex = idx;
    document.querySelectorAll(".opt").forEach((el,i)=>{
      el.classList.toggle("active", i === idx);
    });
    syncSummary();
  }

  function showToast(text){
    const t = document.getElementById("toast");
    t.textContent = text || "Copiado!";
    t.style.display = "block";
    clearTimeout(window.__toastTimer);
    window.__toastTimer = setTimeout(()=> t.style.display="none", 1400);
  }

  async function copyText(txt, okMsg){
    try{
      await navigator.clipboard.writeText(txt);
      showToast(okMsg || "Copiado!");
    }catch(e){
      const temp = document.createElement("textarea");
      temp.value = txt;
      document.body.appendChild(temp);
      temp.select();
      document.execCommand("copy");
      temp.remove();
      showToast(okMsg || "Copiado!");
    }
  }

  function copyPix(){ copyText(PIX_KEY, "Chave Pix copiada!"); }

  function copyCode(){
    if(!purchaseCode){
      alert("Preencha seu nome e WhatsApp para gerar o código da compra.");
      return;
    }
    copyText(purchaseCode, "Código copiado! Faça o Pix e depois confirme.");
  }

  // ✅ AGORA ENVIA PRO CLOUDFARE WORKER (e ele manda no Telegram)
  async function sendToWorker(status){
    const p = selectedPkg();
    const name = (document.getElementById("buyerName").value || "").trim();
    const whatsapp = (document.getElementById("buyerWhats").value || "").trim();
    const ref = getRefFinal();
    const when = new Date().toLocaleString("pt-BR");

    const payload = {
      name,
      whatsapp,
      code: purchaseCode || "—",
      pack: p ? pkgLabel(p) : "—",
      total: p ? brl(p.price) : "—",
      ref,
      when,
      url: location.href,
      status: status || "CLIENTE CLICOU: EU FIZ O PAGAMENTO"
    };

    const resp = await fetch(WORKER_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });

    const txt = await resp.text().catch(()=> "");
    if(!resp.ok){
      throw new Error(txt || "Falha ao enviar para o Worker");
    }
    return txt;
  }

  async function confirmPayment(){
    if(!purchaseCode){
      alert("Primeiro gere o código na etapa do Pix.");
      return;
    }

    showToast("Enviando confirmação…");

    try{
      await sendToWorker("CLIENTE CLICOU: EU FIZ O PAGAMENTO");
      alert("✅ Enviado! Chegou no seu Telegram.");
      showToast("Enviado ✅");
    }catch(err){
      console.error(err);
      alert("❌ Erro ao enviar. Confira a URL do Worker e tente novamente.");
      showToast("Erro ❌");
    }
  }

  function resetFlow(){
    selectedIndex = -1;
    purchaseCode = "";
    document.getElementById("buyerName").value = "";
    document.getElementById("buyerWhats").value = "";
    document.querySelectorAll(".opt").forEach(el=>el.classList.remove("active"));

    const sel = document.getElementById("refSelect");
    sel.value = "direto";
    document.getElementById("refOther").style.display = "none";
    document.getElementById("refOther").value = "";

    goStep(1);
    syncSummary();
  }

  function setupIndicacao(){
    const sel = document.getElementById("refSelect");
    sel.innerHTML = "";

    const opts = [...new Set(["direto", ...INDICADORES.filter(Boolean)])];

    if(refFromUrl){
      opts.unshift(refFromUrl);
    }

    const final = [...new Set(opts)];

    final.forEach(v=>{
      const o = document.createElement("option");
      o.value = v;
      o.textContent = (v === "direto") ? "Direto (sem indicação)" : v;
      sel.appendChild(o);
    });

    const other = document.createElement("option");
    other.value = "__other__";
    other.textContent = "Outro (digitar)";
    sel.appendChild(other);

    if(refFromUrl){
      sel.value = refFromUrl;
    } else {
      sel.value = "direto";
    }

    document.getElementById("miniRef").textContent = sel.value || "—";
    document.getElementById("sumRef1").textContent = sel.value || "—";

    sel.addEventListener("change", ()=>{
      const show = sel.value === "__other__";
      const inp = document.getElementById("refOther");
      inp.style.display = show ? "block" : "none";
      syncSummary();
    });

    document.getElementById("refOther").addEventListener("input", syncSummary);
    document.getElementById("buyerName").addEventListener("input", syncSummary);
    document.getElementById("buyerWhats").addEventListener("input", syncSummary);
  }

  // INIT
  document.getElementById("pixKeyUI").textContent = PIX_KEY;
  document.getElementById("whatsNumberUI").textContent = WHATSAPP_NUMBER;
  renderPackages();
  setupIndicacao();
  setProgress(1);
  syncSummary();
</script>

</body>
</html>
